<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>ê´€ë¦¬ì ê³„ì • ê´€ë¦¬</title>
  <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-light d-flex flex-column min-vh-100">
<header th:replace="layouts/header :: header"></header>
<nav th:replace="layouts/nav :: nav"></nav>

<main class="container my-5 flex-grow-1">
  <div th:if="${member?.userRole != 'admin'}" class="alert alert-danger text-center">
    ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
  </div>

  <div th:if="${member?.userRole == 'admin'}">
    <h2 class="mb-4">ğŸ‘‘ ê´€ë¦¬ì ê³„ì • ê´€ë¦¬</h2>

    <!-- íƒ­ ë©”ë‰´ -->
    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" id="accounts-tab" data-bs-toggle="tab" data-bs-target="#accounts"
                type="button" role="tab">ì „ì²´ ê³„ì • ê´€ë¦¬</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="role-tab" data-bs-toggle="tab" data-bs-target="#role"
                type="button" role="tab">ê´€ë¦¬ì ì„ëª…/í•´ì œ</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="blacklist-tab" data-bs-toggle="tab" data-bs-target="#blacklist"
                type="button" role="tab">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- âœ… ì „ì²´ ê³„ì • íƒ­ -->
      <div class="tab-pane fade show active" id="accounts" role="tabpanel">
        <table class="table table-bordered text-center">
          <thead class="table-light">
            <tr>
              <th>ì„ íƒ</th>
              <th>ì•„ì´ë””</th>
              <th>ë‹‰ë„¤ì„</th>
              <th>ë ˆë²¨</th>
              <th>ê²½í—˜ì¹˜</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="m : ${memberList}">
              <td><input type="checkbox" class="update-check" th:data-id="${m.memberId}"/></td>
              <td th:text="${m.memberId}">user123</td>
              <td th:text="${m.nickName}">ë‹‰ë„¤ì„</td>
              <td>
                <input type="number" class="form-control level-input"
                       th:value="${m.memberLevel}" th:data-original="${m.memberLevel}"
                       th:data-id="${m.memberId}" />
              </td>
              <td>
                <input type="number" class="form-control exp-input"
                       th:value="${m.memberExp}" th:data-original="${m.memberExp}"
                       th:data-id="${m.memberId}" />
              </td>
            </tr>
          </tbody>
        </table>
        <button id="saveMemberChangesBtn" class="btn btn-primary">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
      </div>

      <!-- ğŸ‘‰ í–¥í›„ ë‹¤ë¥¸ íƒ­ë„ ì—¬ê¸°ì— -->
      <div class="tab-pane fade" id="role" role="tabpanel">ê´€ë¦¬ì ì„ëª…/í•´ì œ ê¸°ëŠ¥ ì˜ˆì •</div>
      <div class="tab-pane fade" id="blacklist" role="tabpanel">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë“±ë¡/í•´ì œ ê¸°ëŠ¥ ì˜ˆì •</div>
    </div>
  </div>
</main>

<script>
  $(function () {
    $(".level-input, .exp-input").on("input", function () {
      const $input = $(this);
      const memberId = $input.data("id");

      const $level = $(`.level-input[data-id='${memberId}']`);
      const $exp = $(`.exp-input[data-id='${memberId}']`);

      const isChanged = $level.val() !== $level.data("original").toString() ||
                        $exp.val() !== $exp.data("original").toString();

      $(`.update-check[data-id='${memberId}']`).prop("checked", isChanged);
    });

    $("#saveMemberChangesBtn").click(function () {
      const updates = [];

      $(".update-check:checked").each(function () {
        const id = $(this).data("id");
        const level = $(`.level-input[data-id='${id}']`).val();
        const exp = $(`.exp-input[data-id='${id}']`).val();
        updates.push({ memberId: id, level: level, exp: exp });
      });

      if (updates.length === 0) {
        alert("ë³€ê²½ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      $.ajax({
        url: "/admin/updateMembers",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(updates),
        success: function () {
          alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
          location.reload();
        },
        error: function () {
          alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
      });
    });
  });
</script>

</body>
</html>
